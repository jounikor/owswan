/*
 * (c) 2022 Jouni 'mr.spiv' Korhonen
 * Some testing with chunky modes and raster irqs.
 */

#include <stdint.h>
#include <libwsc.h>

uint16_t g_hcnt;
uint16_t* __near g_chunky_buffer;
uint16_t* __near g_chunky;
uint8_t g_wait_vb;

// Stripe 0001 0010 0011 0100 0101 0110 0111 1000 
#pragma pack(2)

const uint8_t __far tile0[] = {
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00
};

const uint8_t __far tile1[] = {
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22,
    0x11,0x11,0x22,0x22
};

// Stripe 1001 1010 1011 1100 1101 1110 1111 0000
const uint8_t __far tile2[] = {
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44,
    0x33,0x33,0x44,0x44
};

// Stripe 0000 0000 0000 0000 0000 0000 0000 0001
const uint8_t __far tile3[] = {
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66,
    0x55,0x55,0x66,0x66
};
const uint8_t __far tile4[] = {
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88,
    0x77,0x77,0x88,0x88
};
const uint8_t __far tile5[] = {
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa,
    0x99,0x99,0xaa,0xaa
};
const uint8_t __far tile6[] = {
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc,
    0xbb,0xbb,0xcc,0xcc
};
const uint8_t __far tile7[] = {
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee,
    0xdd,0xdd,0xee,0xee
};
const uint8_t __far tile8[] = {
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00,
    0xff,0xff,0x00,0x00
};

/* FG tiles start here */
const uint8_t __far tile9[] = {
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa,
    0x00,0x00,0xaa,0xaa
};
const uint8_t __far tile10[] = {
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb,
    0x00,0x00,0xbb,0xbb
};
const uint8_t __far tile11[] = {
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc,
    0x00,0x00,0xcc,0xcc
};

const uint16_t __far bg_line[] = {
    0x0001,0x0002,
    0x0003,0x0004,
    0x0005,0x0006,
    0x0007,0x0008,
    0x0201,0x0202,
    0x0203,0x0204,
    0x0205,0x0206,
    0x0207,0x0208,
    0x0401,0x0402,
    0x0403,0x0404,
    0x0405,0x0406,
    0x0407,0x0408,
    0x0601,0x0602,
    0x0603,0x0604,
    0x0000,0x0000,
    0x0000,0x0000
};

const uint16_t __far fg_line[] = {
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x0609,  // 9
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x060a,  // a
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x060b,  // b
    0x0000,0x0000,
    0x0000,0x0000,
    0x0000,0x0000
};



void __interrupt __far  vb_irq(void)
{
    *(uint16_t *)(FIXADDR_PAL_0_7) = 0;
    g_hcnt = 0;
    g_wait_vb++;
    g_chunky = g_chunky_buffer;
    OUTB(REG_LINE_CMP,g_hcnt);
    ack_hw_irq(HWINT_VBLANK);
}

void __interrupt __far hline_irq(void)
{
    uint16_t * __near pal = (uint16_t *)(FIXADDR_PAL_0_7+2);
    uint16_t * __near s = g_chunky;

    /* This produces actually decent code.. */
    pal[1-1] = s[0];        /* SRC0, palette 0, colors 1->15 */
    pal[2-1] = s[1];
    pal[3-1] = s[2];
    pal[4-1] = s[3];
    pal[5-1] = s[4];
    pal[6-1] = s[5];
    pal[7-1] = s[6];
    pal[8-1] = s[7];
    pal[9-1] = s[8];
    pal[10-1] = s[9];
    pal[11-1] = s[10];
    pal[12-1] = s[11];
    pal[13-1] = s[12];
    pal[14-1] = s[13];
    pal[15-1] = s[14];
    pal[58-1] = s[15];      /* SRC1, palette 4, color 10 */
    pal[17-1] = s[16];      /* SRC0, palette 1, colors 1->15 */
    pal[18-1] = s[17];
    pal[19-1] = s[18];
    pal[20-1] = s[19];
    pal[21-1] = s[20];
    pal[22-1] = s[21];
    pal[23-1] = s[22];
    pal[24-1] = s[23];
    pal[25-1] = s[24];
    pal[26-1] = s[25];
    pal[27-1] = s[26];
    pal[28-1] = s[27];
    pal[29-1] = s[28];
    pal[30-1] = s[29];
    pal[31-1] = s[30];
    pal[59-1] = s[31];      /* SRC1, palette 4, color 11 */
    pal[33-1] = s[32];      /* SRC0, palette 3, colors 1-15 */
    pal[34-1] = s[33];
    pal[35-1] = s[34];
    pal[36-1] = s[35];
    pal[37-1] = s[36];
    pal[38-1] = s[37];
    pal[39-1] = s[38];
    pal[40-1] = s[39];
    pal[41-1] = s[40];
    pal[42-1] = s[41];
    pal[43-1] = s[42];
    pal[44-1] = s[43];
    pal[45-1] = s[44];
    pal[46-1] = s[45];
    pal[47-1] = s[46];
    pal[60-1] = s[47];      /* SRC1, palette 4, color 12 */
    pal[49-1] = s[48];      /* SRC0, palette 4, colors 1->9 */
    pal[50-1] = s[49];
    pal[51-1] = s[50];
    pal[52-1] = s[51];
    pal[53-1] = s[52];
    pal[54-1] = s[53];
    pal[55-1] = s[54];
    pal[56-1] = s[55];
    g_chunky = s+56;

    g_hcnt += 4;
    OUTB(REG_LINE_CMP,g_hcnt);
    ack_hw_irq(HWINT_LINE);
}

void prep_chunky(uint16_t * chunky, uint16_t color)
{
    int n;
    g_chunky_buffer = chunky;

    for (n = 0; n < 56*36; n++) {
        chunky[n] = color;
        color += 0x123;
    }
}

#define BG_MAP 0x2000   /* SCR0 */
#define FG_MAP 0x2800   /* SCR1 */
#define CHUNKY0 0xc000
#define CHUNKY1 (CHUNKY0+56*36*2)

void __far main(void)
{
    int n;
    uint16_t * m;
    uint16_t color = 10;


    disable_irq();
    OUTB(REG_DISP_MODE,DISP_4BPP|DISP_COLOR|DISP_FORMAT_PACKED);

    /* Move tile data.. total 17 of those */
    memcpy((void *)0x4000,(void *)tile0,sizeof(tile0)*12);

    /* Create BG and FG tile maps.. */

    memcpy((void*)BG_MAP,bg_line,64);
    dma_copy_ram((void*)(BG_MAP+64),(void*)BG_MAP,64*17);

    /* Create BG and FG tile maps.. */
    memcpy((void*)FG_MAP,fg_line,64);
    dma_copy_ram((void*)(FG_MAP+64),(void*)FG_MAP,64*17);

    /* ... */

    set_hw_irq(vb_irq,HWINT_VBLANK);
    set_hw_irq(hline_irq,HWINT_LINE);

    OUTB(REG_SCR1_X,0);
    OUTB(REG_SCR1_Y,0);
    OUTB(REG_SCR2_X,0);
    OUTB(REG_SCR2_Y,0);
    OUTB(REG_SCR2_X,0);
    OUTB(REG_DISP_CTRL,SCR1_ENABLE|SCR2_ENABLE);
    OUTB(REG_MAP_BASE,0x54);
    OUTB(REG_LCD_CTRL,LCD_ENABLE|LCD_CONTRAST_HGH);
    OUTB(REG_BACK_COLOR,0);

    OUTB(REG_LINE_CMP,0);

    /* */
    m = (uint16_t*)CHUNKY0;
    prep_chunky(m,color);
    g_wait_vb = 0;

    enable_irq();
    
    while (1) {
        while (g_wait_vb == 0);
        
        color++;

        if (m == (uint16_t*)CHUNKY0) {
            m = (uint16_t*)CHUNKY1;
        } else {
            n = (uint16_t*)CHUNKY0;
        }

        prep_chunky(m,color);
        g_wait_vb = 0;
        *(uint16_t *)(FIXADDR_PAL_0_7) = 0xf00;
    }
}



